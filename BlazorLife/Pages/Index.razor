@page "/"
@inject WindowInterop _windowInterop;

@if (!_started)
{
    @*<select class="lifeStartMode">
        <option value=@StartOptions.Random>Random (10% alive)</option>
        <option value=@StartOptions.Blank>Blank</option>
    </select>*@
}
else
{
    <h2 class="lifeText">Generations passed @_generationsPassed</h2>
}

<form @onsubmit="OnStartStop" @onreset="OnReset">
    @if (_started)
    {
        <button class="lifeControlButton lifeStarted" type="submit">Stop life simulation</button>
    }
    else if (_generationsPassed == 0)
    {
        <button class="lifeControlButton" type="submit">Start life simulation</button>
    }
    else
    {
        <button class="lifeControlButton" type="submit">Continue life simulation</button>
        <button class="lifeControlButton" type="reset">Reset life simulation</button>
    }
</form>

<div class="gliderMode">
    <input type="checkbox" id="gliderMode-checkbox" value=@_isGlider @onchange=@OnGliderModeValueChange>
    <label class="gliderMode-label" for="gliderMode-checkbox">
        <span class="gliderMode-inner"></span>
    </label>
</div>

@if (_isGlider)
{
    <div class="gliderDirection">
        <label class="gliderDirectionLabel">
            <input type="radio"
                   class="gliderDirectionRadio"
                   name="gliderDirection"
                   value="@GliderDirection.UpLeft"
                   @onchange="OnDirectionChange"
                   checked="@(_gliderDirection == GliderDirection.UpLeft)">
            <span class="gliderCheckBox"></span>
        </label>
        <label class="gliderDirectionLabel">
            <input type="radio"
                   class="gliderDirectionRadio"
                   name="gliderDirection"
                   value="@GliderDirection.UpRight"
                   @onchange="OnDirectionChange"
                   checked="@(_gliderDirection == GliderDirection.UpRight)">
            <span class="gliderCheckBox"></span>
        </label>
        <label class="gliderDirectionLabel">
            <input type="radio"
                   class="gliderDirectionRadio"
                   name="gliderDirection"
                   value="@GliderDirection.DownLeft"
                   @onchange="OnDirectionChange"
                   checked="@(_gliderDirection == GliderDirection.DownLeft)">
            <span class="gliderCheckBox"></span>
        </label>
        <label class="gliderDirectionLabel">
            <input type="radio"
                   class="gliderDirectionRadio"
                   name="gliderDirection"
                   value="@GliderDirection.DownRight"
                   @onchange="OnDirectionChange"
                   checked="@(_gliderDirection == GliderDirection.DownRight)">
            <span class="gliderCheckBox"></span>
        </label>
    </div>
}

@code {
    private Grid _grid;

    private int _delay = 20;

    private int _pixelSize = 10;

    private int _generationsPassed = 0;

    private bool _started = false;

    private bool _isGlider = true;

    private GliderDirection _gliderDirection = GliderDirection.DownRight;

    private (int Rows, int Cols) _size;

    [JSInvokable]
    public async Task JsOnClick(CellData[] cells)
    {
        foreach (var cell in cells)
        {
            _grid.Set(cell.X, cell.Y, cell.IsAlive);
        }
        await Task.Yield();
    }

    protected override async Task OnInitializedAsync()
    {
        await _windowInterop.Init(DotNetObjectReference.Create(this), _pixelSize, _isGlider, _gliderDirection);

        var (rows, cols) = _size = await _windowInterop.GetSize(_pixelSize);

        _grid = new Grid(cols, rows, 0.1);
        await _windowInterop.Paint(_grid.GetAliveCells());
    }

    private async Task OnDirectionChange(ChangeEventArgs evt)
    {
        _gliderDirection = Enum.Parse<GliderDirection>((string)evt.Value);
        await _windowInterop.SwitchGliderDirection(_gliderDirection);
    }

    private async Task OnGliderModeValueChange(ChangeEventArgs evt)
    {
        _isGlider = !_isGlider;
        await _windowInterop.SwitchMode(_isGlider);
    }

    private async Task OnStartStop()
    {
        if (_started)
        {
            _started = false;
        }
        else
        {
            _started = true;
            await OnStart();
        }
    }

    private async Task OnReset()
    {
        await _windowInterop.Clear();
        _grid = new Grid(_size.Cols, _size.Rows, 0.1);
        await _windowInterop.Paint(_grid.GetAliveCells());
        _generationsPassed = 0;
    }

    private async Task OnStart()
    {
        while (_started)
        {
            var data = _grid.NextGeneration();
            await _windowInterop.Paint(data.alive, data.dead);
            _generationsPassed++;
            await Task.Delay(_delay);
            StateHasChanged();
        }
    }
}
